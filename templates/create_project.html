{% extends "base.html" %}

{% block title %}Beekeeper - New Project{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/" class="back-btn">&larr; Back</a>
    <h1>New Project</h1>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="card flash-card">
    {% for category, message in messages %}
    <p class="flash flash-{{ category }}">{{ message }}</p>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<form action="{{ url_for('project.create') }}" method="POST" class="card">
    <div class="form-group">
        <label for="name">Project Name (no spaces)</label>
        <input type="text" id="name" name="name" required
               pattern="[a-zA-Z0-9_-]+" placeholder="my-training-run">
    </div>

    <div class="form-group">
        <label for="git_url">Git URL</label>
        <input type="text" id="git_url" name="git_url" required
               placeholder="https://github.com/user/repo.git">
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="branch">Default Branch</label>
            <input type="text" id="branch" name="branch" value="main">
        </div>

        <div class="form-group">
            <label for="python_version">Python Version</label>
            <select id="python_version" name="python_version">
                {% for pv in python_versions %}
                <option value="{{ pv.version }}"
                        data-source="{{ pv.source }}"
                        {% if loop.first %}selected{% endif %}>
                    Python {{ pv.version }} ({{ pv.source }})
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    {% if conda_available %}
    <div class="form-group">
        <label>Environment Type</label>
        <div class="env-toggle">
            <label class="toggle-option">
                <input type="radio" name="env_type" value="venv" checked>
                <span class="toggle-label">venv</span>
            </label>
            <label class="toggle-option">
                <input type="radio" name="env_type" value="conda">
                <span class="toggle-label">conda</span>
            </label>
        </div>
    </div>
    {% endif %}

    <div class="form-group">
        <label for="train_file">Training Script</label>
        <input type="text" id="train_file" name="train_file" value="train.py">
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="tensorboard_log_dir">Tensorboard Log Dir</label>
            <input type="text" id="tensorboard_log_dir" name="tensorboard_log_dir" value="runs">
        </div>

        <div class="form-group">
            <label for="requirements_file">Requirements File</label>
            <input type="text" id="requirements_file" name="requirements_file" value="requirements.txt">
        </div>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Create Project</button>
        <a href="/" class="btn btn-cancel">Cancel</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    // Auto-select conda when a conda-only version is picked
    const versionSelect = document.getElementById("python_version");
    const envRadios = document.querySelectorAll('input[name="env_type"]');
    if (versionSelect && envRadios.length) {
        versionSelect.addEventListener("change", function () {
            const opt = this.options[this.selectedIndex];
            const source = opt.dataset.source;
            if (source === "conda") {
                envRadios.forEach(r => { if (r.value === "conda") r.checked = true; });
            }
        });
    }
</script>
{% endblock %}
