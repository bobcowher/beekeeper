{% extends "base.html" %}

{% block title %}Beekeeper - Edit {{ project.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <a href="{{ url_for('project.detail', name=project.name) }}" class="back-btn">&larr; Back</a>
    <h1>Edit {{ project.name }}</h1>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="card flash-card">
    {% for category, message in messages %}
    <p class="flash flash-{{ category }}">{{ message }}</p>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<form action="{{ url_for('project.update', name=project.name) }}" method="POST" class="card">
    <h2>Project Settings</h2>

    <div class="form-group">
        <label for="branch">Git Branch</label>
        <input type="text" id="branch" name="branch" value="{{ project.branch }}">
    </div>

    <div class="form-group">
        <label for="train_file">Training Script</label>
        <input type="text" id="train_file" name="train_file" value="{{ project.train_file }}">
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="tensorboard_log_dir">Tensorboard Log Dir</label>
            <input type="text" id="tensorboard_log_dir" name="tensorboard_log_dir" value="{{ project.tensorboard_log_dir }}">
        </div>

        <div class="form-group">
            <label for="requirements_file">Requirements File</label>
            <input type="text" id="requirements_file" name="requirements_file" value="{{ project.requirements_file }}">
        </div>
    </div>

    <h2>Environment Variables</h2>
    <p class="muted" style="margin-bottom: 12px">These are passed to the training process. Values are stored in project.json.</p>

    <div id="env-vars-list">
        {% for key, val in (project.get('env_vars') or {}).items() %}
        <div class="env-var-row form-row">
            <div class="form-group">
                <input type="text" name="env_key" value="{{ key }}" placeholder="KEY">
            </div>
            <div class="form-group">
                <input type="text" name="env_val" value="{{ val }}" placeholder="value">
            </div>
            <button type="button" class="btn btn-danger btn-sm btn-remove-env">&times;</button>
        </div>
        {% endfor %}
    </div>
    <button type="button" class="btn btn-secondary" id="btn-add-env">+ Add Variable</button>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="{{ url_for('project.detail', name=project.name) }}" class="btn btn-cancel">Cancel</a>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    const envList = document.getElementById("env-vars-list");
    const btnAdd = document.getElementById("btn-add-env");

    btnAdd.addEventListener("click", () => {
        const row = document.createElement("div");
        row.className = "env-var-row form-row";
        row.innerHTML = `
            <div class="form-group">
                <input type="text" name="env_key" placeholder="KEY">
            </div>
            <div class="form-group">
                <input type="text" name="env_val" placeholder="value">
            </div>
            <button type="button" class="btn btn-danger btn-sm btn-remove-env">&times;</button>
        `;
        envList.appendChild(row);
        row.querySelector("input").focus();
    });

    envList.addEventListener("click", (e) => {
        if (e.target.classList.contains("btn-remove-env")) {
            e.target.closest(".env-var-row").remove();
        }
    });
</script>
{% endblock %}
